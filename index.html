<!doctype html>
<html lang="en">

        <head>
                <meta charset="utf-8">

                <title>Python War Stories (Pt.1)</title>

                <meta name="description" content="Python War Stories (Pt.1)">
                <meta name="author" content="Brett Carter">

                <meta name="apple-mobile-web-app-capable" content="yes" />
                <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

                <link rel="stylesheet" href="css/reveal.min.css">
                <link rel="stylesheet" href="css/theme/default.css" id="theme">
                <link rel="stylesheet" href="style.css">

                <!-- For syntax highlighting -->
                <link rel="stylesheet" href="lib/css/zenburn.css">

                <!-- If the query includes 'print-pdf', use the PDF print sheet -->
                <script>
                        document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
                </script>

                <!--[if lt IE 9]>
                <script src="lib/js/html5shiv.js"></script>
                <![endif]-->

        </head>

        <body>

                <div class="reveal">

                        <!-- Any section element inside of this container is displayed as a slide -->
                        <div class="slides">
                                <section>
                                        <h1>Python War Stories (Pt.1)</h1>
                                        <h3>From the trenches</h3>
                                        <p>
                                                <small>Created by <a href="http://rdnzl.net">Brett Carter</a> / <a href="http://twitter.com/zbskii">@zbskii</a></small>
                                        </p>
                                </section>
                                <section>
                                        <h3>I work at AppNexus</h3>
                                        <p>
                                          We have a lot of data.
                                        </p>
                                </section>
                                <section>
                                        <h3>Background</h3>
                                        <p>
                                          I mostly do backend work.  Databases, servers, DevOps, etc.
                                        </p>
                                </section>
                                <section>
                                        <h3>Background</h3>
                                        <p class="fragment">
                                          On my first day of work: "So you know python right?"
                                        </p>
                                        <p class="fragment">
                                          Yeah...
                                        </p>
                                        <p class="fragment">
                                          "We have this data loading script for hadoop, but something is strange..."
                                        </p>
                                        <p class="fragment">
                                          Ok...
                                        </p>

                                </section>
                                <section>
                                        <h3>The script</h3>
                                        <p>
                                          Every 24 hours we generate <em>200 Gigabytes</em> of segment data.
                                          Our script is broken into four phases:
                                          <ol>
                                            <li>Get metadata</li>
                                            <li>Download each gzipped csv file as specified in (1)</li>
                                            <li>Unzip each part as specified in (1)</li>
                                            <li>Write a monotonically incrasing index in for each line in each csv</li>
                                          </ol>
                                        </p>
                                </section>
                                <section>
                                        <h3>The strangeness</h3>
                                        <p class="fagment">
                                          "So we generate this data every 24 hours, but the script never seems to finish"
                                        </p>
                                        <p class="fagment">
                                          Ok...
                                        </p>
                                        <p class="fagment">
                                          (The script was taking ~60 hours to complete...)
                                        </p>
                                </section>
                                <section>
                                    <h3>Fuck yeah optimization!</h3>
                                    <p>
                                      I love this kind of stuff.  I live for optimization problems. But there are rules...
                                    </p>
                                </section>
                                <section>
                                    <h3>"Every man must have a code..."</h3>
                                    <p>
                                      <blockquote>
                                        "Optimization is the root of all evil"
                                                               --Knuth
                                      </blockquote>
                                    </p>
                                </section>
                                <section>
                                    <h3>Game plan</h3>
                                    <p>
                                      <ol>
                                        <li>Set a budget</li>
                                        <li>Measure current spending habits</li>
                                        <li>Figure out easiest place to make cuts</li>
                                        <li>GOTO: 2 unless spending habits == budget</li>
                                      </ol>
                                    </p>
                                </section>
                                <section>
                                    <h3>Budget</h3>
                                    <p>
                                      24 hours.
                                    </p>
                                </section>
                                <section>
                                    <h3>Spending Habits</h3>
                                    <p>
                                      <ul>
                                        <li>5 hours to download ~600 parts</li>
                                        <li>4 hours to unzip each part</li>
                                        <li>4 hours to add an id to each line in each part part</li>
                                        <li>Importing each part takes ~5mins * 600 50hours (!)</li>
                                    </p>
                                </section>
                                <section>
                                    <h3>The Future</h3>
                                    <p>
                                      Clearly, the script was IO bound
                                      on 1 process.  This is usually a
                                      good case for adding some
                                      concurrency, especially in
                                      Python.
                                    </p>
                                </section>

                                <section>
                                    <h3>The Future</h3>
                                    <p>
                                      We were already using the excellent <a href="http://docs.python-requests.org/en/latest/">Requests</a> library,
                                      a little digging found <a href="https://github.com/ross/requests-futures">Requests.futures</a>. Let's get busy!
                                    </p>
                                </section>

                                  <section>
                                    This:
                                    <pre> <code class="python">
import requests
session = requests.Session()
r = session.get(url, stream=True)
                                    </code>
                                    </pre>
                                    Becomes:
                                    <pre> <code class="python">
from requests_futures import FutureSession
session = FutureSession()
async_downloads.append(session.get(url, stream=True))
for f in futures.as_completed(async_downloads):
    pass

                                    </code>
                                    </pre>
                                  </section>
                                  <section>
                                    <h3>Futures</h3>
                                    <p>
                                      What's a Future?  See schmichael's "History of concurrency talk"
                                    </p>
                                      <pre class="stretch"> <code class="python">
from requests_futures import FutureSession
session = FutureSession()
async_downloads.append(session.get(url, stream=True))
for f in futures.as_completed(async_downloads):
    pass
                                    </code>
                                    </pre>
                                  </section>

                                  <section>
                                    <h3>Spending habits</h3>
                                    <ul>
                                      <li><strike>5</strike> 1 hours to download ~600 parts</li>
                                      <li>4 hours to unzip each part</li>
                                      <li>4 hours to add an id to each line in each part part</li>
                                      <li>Importing each part takes ~5mins * 600 50hours (!)</li>
                                    </ul>
                                  </section>
                                  <section>
                                    <h3>See futures + gzip</h3>
                                    <p>
                                      pretty much the same, but processes worked better.
                                    </p>
                                  </section>
                                  <section>
                                    <h3>Spending habits</h3>
                                    <ul>
                                      <li><strike>5</strike> ~1 hours to download ~600 parts</li>
                                      <li><strike>4</strike> ~1 hours to unzip each part and add a uuid</li>
                                      <li><strike>4 hours to add an id to each line in each part part</strike></li>
                                      <li>Importing each part takes ~5mins * 600 50hours (!)</li>
                                    </ul>
                                  </section>

                                  <section>
                                    <h3>Summary</h3>
                                    <ul>
                                      <li>Create a budget</li>
                                      <li>Review spending habits</li>
                                      <li>Cut the easiest things first</li>
                                      <li>STOP when you meet your budget!</li>
                                    </ul>
                                  </section>
                                  <section>
                                    <h3>What about solr?</h3>
                                    <p>
                                      Well... that's another talk :)
                                    </p>
                                  </section>
                                  <section>
                                    <h3>Shameless plug</h3>
                                    <p>
                                    We're hiring!
                                    </p>
                                    <img src="an.png" border="none" />
                                    <p>bcarter@appnexus.com</p>
                                  </section>

                        </div>

                </div>

                <script src="lib/js/head.min.js"></script>
                <script src="js/reveal.min.js"></script>

                <script>

                        // Full list of configuration options available here:
                        // https://github.com/hakimel/reveal.js#configuration
                        Reveal.initialize({
                                controls: true,
                                progress: true,
                                history: true,
                                center: true,

                                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                                transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

                                // Optional libraries used to extend on reveal.js
                                dependencies: [
                                        { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                                        { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                                        { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                                        { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                                        { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                                        { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                                ]
                        });

                  var done = {};
                  Reveal.addEventListener( 'map1', function() {
                    if(! done.map1){
                      _renderMap('#map1');
                      done.map1 = true;
                    }
                  });
                  Reveal.addEventListener( 'map2', function() {
                    if(! done.map2){
                      var state = _renderMap('#map2');
                      _getLoginsStatic(state);
                      done.map2 = true;
                    }
                  });
                  Reveal.addEventListener( 'map3', function() {
                    if(! done.map3){
                      var state = _renderMap('#map3');
                      _getLogins(state, 'cities_small.json');
                      done.map3 = true;
                    }
                  });
                  Reveal.addEventListener( 'map4', function() {
                    if(! done.map4){
                      var state = _renderMap('#map4');
                      _getLogins(state, 'cities.json');
                      done.map4 = true;
                    }
                  });

                </script>
        </body>
</html>
